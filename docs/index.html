<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>pymilter: Writing Milters in Python</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">pymilter
   &#160;<span id="projectnumber">1.0.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Writing Milters in Python </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>At the lowest level, the <code>milter</code> module provides a thin wrapper around the <a href="milter_api/index.html">sendmail libmilter API</a>. This API lets you register callbacks for a number of events in the process of sendmail receiving a message via SMTP. These events include the initial connection from a MTA, the envelope sender and recipients, the top level mail headers, and the message body. There are options to mangle all of these components of the message as it passes through the milter.</p>
<p>At the next level, the <code><a class="el" href="namespaceMilter.html" title="A thin OO wrapper for the milter module. ">Milter</a></code> module (note the case difference) provides a Python friendly object oriented wrapper for the low level API. To use the <a class="el" href="namespaceMilter.html" title="A thin OO wrapper for the milter module. ">Milter</a> module, an application registers a 'factory' to create an object for each connection from a MTA to sendmail. These connection objects must provide methods corresponding to the libmilter event callbacks.</p>
<p>Each callback method returns a code to tell sendmail whether to proceed with processing the message. This is a big advantage of milters over other mail filtering systems. Unwanted mail can be stopped in its tracks at the earliest possible point. The callback return codes are <a class="el" href="namespacemilter.html#a590b7ab395513af007869ad83e332c14" title="Continue processing the current connection, message, or recipient. ">milter.CONTINUE</a>, <a class="el" href="namespacemilter.html#a2345250030581a1639ecf905e1668b0a" title="For a connection-oriented routine, reject this connection; call Milter.Base.close(). ">milter.REJECT</a>, <a class="el" href="namespacemilter.html#a4c8bad190cb7f54cea87f1182732ce83" title="For a message- or recipient-oriented routine, accept this message, but silently discard it...">milter.DISCARD</a>, <a class="el" href="namespacemilter.html#ae40b8bfbb6828233115c61490998f7f4" title="For a connection-oriented routine, accept this connection without further filter processing; call Mil...">milter.ACCEPT</a>, <a class="el" href="namespacemilter.html#a1b4940e90c267a81cba6be20aa782e85" title="Return a temporary failure, i.e., the corresponding SMTP command will return an appropriate 4xx statu...">milter.TEMPFAIL</a>, <a class="el" href="namespacemilter.html#aa2fa23a83f9bbc204eb14313a6efd4cc" title="Skip further callbacks of the same type in this transaction. ">milter.SKIP</a>, <a class="el" href="namespacemilter.html#a45378e0b42f76927adaf504b6082fc7d" title="Do not send a reply back to the MTA. ">milter.NOREPLY</a>.</p>
<p>The <a class="el" href="classMilter_1_1Base.html" title="A do &quot;nothing&quot; Milter base class representing an SMTP connection. ">Milter.Base</a> class provides default implementations for event methods that do nothing, and also provides wrappers for the libmilter methods to mutate the message. It automatically negotiates with MTA which protocol steps need to be processed by the milter, based on which callback methods are overridden.</p>
<p>The <a class="el" href="classMilter_1_1Milter.html" title="A logging but otherwise do nothing Milter base class. ">Milter.Milter</a> class provides an alternate default implementation that logs the main milter callbacks, but otherwise does nothing. It is provided for compatibility.</p>
<p>The mime module provides a wrapper for the Python email package that fixes some bugs, and simplifies modifying selected parts of a MIME message.</p>
<h1><a class="anchor" id="threading"></a>
threading</h1>
<p>The libmilter library which pymilter wraps <a href="milter_overview#SignalHandling">handles all signals</a> itself, and expects to be called from a single main thread. It handles SIGTERM, SIGHUP, and SIGINT, mapping the first two to <a href="milter_api/smfi_stop.html">smfi_stop</a> and the last to an internal ABORT.</p>
<p>If you use python threads or threading modules, then signal handling gets confused. Threads may still be useful, but you may need to provide an alternate means of causing graceful shutdown.</p>
<p>You may find the <a href="http://docs.python.org/release/2.6.6/library/multiprocessing.html">multiprocessing</a> module useful. It can be a drop-in replacement for threading as illustrated in <a href="milter-template_8py-example.html">milter-template.py</a>.</p>
<h1><a class="anchor" id="Useful"></a>
python packages for milters</h1>
<p><a href="https://github.com/sdgathman/pymilter">pymilter</a> - this package.</p>
<p><a href="https://github.com/sdgathman/pyspf">pyspf</a> checks the SMTP envelope sender (MAIL FROM, passed to the <a class="el" href="classMilter_1_1Base.html#ac8f026580efbc83c4901693828a362f5" title="Called when the SMTP client says MAIL FROM. ">Milter.Base.envfrom</a> callback) against a Sender Policy published in DNS by the sending domain. This can prevent forgery of the MAIL FROM. SPF is Sender Policy Framework.</p>
<p><a href="https://launchpad.net/dkimpy">pydkim</a> checks a DKIM signature of the email body and headers against a public key published in DNS by the signing domain. DKIM is DomainKeys Identified Mail.</p>
<p>The <a href="https://pypi.python.org/pypi/authres/">authres</a> module parses and formats the Authentication-Results email header, providing a standard place to summarize the results from DKIM, SPF, rDNS, SMTP AUTH, and other email authentication methods.</p>
<p><a href="https://github.com/sdgathman/pydspam/">pydspam</a> wraps the libdspam API of the <a href="http://dspam.sourceforge.net/">DSPAM</a> project.</p>
<p><a href="https://github.com/sdgathman/pysrs/">pysrs</a> rewrites MAIL FROM to include a timestamped signature so that "bounce spam" can be immediately rejected.</p>
<p><a href="https://github.com/sdgathman/pygossip/">pygossip</a> is a system to track reputation by domain and authentication level and type, and a simple protocol to gossip about reputations with other mail servers.</p>
<h1><a class="anchor" id="Milters"></a>
written with pymilter</h1>
<p><a href="https://github.com/croessner/vrfydmn">Verify Domain</a> is a Postfix milter that rejects/fixes manipulated From: header on a mail host with multiple virtual domains.</p>
<p><a href="https://github.com/sdgathman/milter/">BMS Milter</a> has several milters, a big complicated spam filter that integrates multiple authentication protocols with pydspam, and two simple ones: spfmilter.py and dkim-milter.py. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
